# Task

Task is a class to support concurrent execution of mruby/c.
When executing multiple programs concurrently, one program can control the execution state of the other programs.
By using Task, the program can be executed by giving its bytecode.

## Task controlling

mruby/c has the feature of concurrently executing multiple programs.
Each concurrently running program is called a task.
The Task class provides a function to control the operation of another task from one task.

Each task is named by `name` member. Tasks can be distinguished by their names. 
Tasks can be controlled from one task to another by specifying the name of task.

To name a task, assign a string value to `name` member as following.

```Ruby
Task.name = "Task1"

while true
  puts "task 1"
  sleep 1
end
```

When this program is executed, this `Task1` outputs `"task1"`.

`Task1` can be controlled from another task. When the method suspend is called, the output `"task 1"` will be stopped.
In the following program, the output of `"task1"` stops 10 seconds after the program starts. And more, five seconds later, the output of `"task 1"` resumes.



```Ruby
sleep 10

task1 = Task.get("Task1");

puts "Suspend Task1"
task1.suspend

sleep 5

puts "Resume Task1"
task1.resume
```

## Class Method

### Task.create(byte_code, regs_size = nil) -> Task

- Create new task from a mruby bytecode.
- `byte_code` is the bytecode generated by compiling the following program.
- The new generated task is initially in a stopped state (`TASKSTATE_DORMANT`).
Use `run` method to execute the task. 
- The register size to be allocated by the VM is passed in the `size` parameter. If `size` is not given, the register size is the default (`MAX_REGS_SIZE`).


The following example shows how to create a new task and run it. The `byte_code` is a generated bytecode from the mruby source.

```Ruby
byte_code = "RITE0300\x00\x00\x00xMATZ0000IREP\x00\x00\x00\\0300\x00\x00\x00P\x00\x02\x00\a\x00\x00\x00\x00\x00\x00\x00\"\x06\x01Q\x03\x00\x01\x04\x01=\x04\x01\x01\x01\x04R\x03-\x02\x00\x01\a\x03-\x02\x01\x01%\xFF\xE5\x11\x028\x02i\x00\x01\x00\x00\aTask1: \x00\x00\x02\x00\x04puts\x00\x00\x05sleep\x00END\x00\x00\x00\x00\b"

task1 = Task.create(byte_code)
task1.run
```

The previous example bytecode `byte_code` is generated by `mrbc` from following mruby code. 

```Ruby
i = 0
while true
  puts "Task1: #{i += 1}"
  sleep 1
end
```

### list -> Array[Task]

- Return array of tasks, which are not only running tasks but also stopped tasks.

### name_list -> Array[String]

- Return an array of task names.

The following code shows the list of tasks.

```Ruby
Task.name = "Task1"

sleep 10
```

```Ruby
Task.name = "Task2"

p Task.list       # => [#<Task:6a9f63a8>, #<Task:6a9f63d4>]
p Task.name_list  # => ["Task2", "Task1"]
```


## Instance Method

### run

- Execute a task, which is created by `create` method and in the stopped state.

### rewind

- Initialize and execute a stopped task.


### name=

- Set task name.ã€€`name` methods names its own task.

### name -> String

- Get task name which is set by `name=`.

### current -> Task
### get -> Task
### get(task_name) -> Task

- Return a task, which is named by `name`.
- If `task_name` is not given, `get` returns its own task(myself).
- If `task_name` is not found, `get` returns nil.

### join -> Task

- Wait for a task. `join` synchronizes between its own task and another task.

The following example shows that the Task1 is joined to the another task.

```Ruby
Task.name = "Task1"

10.times do |i|
  puts "task 1 #{i}"
  sleep 1
end
```

```Ruby
task1 = Task.get("Task1");

3.times do |i|
    puts "task 2 #{i}"
    sleep 1.5
end

puts "Waiting for Task1"

task1.join

puts "Tasks completed"
```

### priority=

- Set task priority, which is 0 to 255. The highest priority is 0.

### priority -> Integer

- Get task priority.

### status -> String

- Return task status as string like `READY`, `WAITING`, `SUSPENDED` or `DORMANT`.
- Especially in `WAITING` status, `stauts` returns its reason like `WAITING SLEEP`.

### suspend

Suspend a task. To suspend other task, first get the task object by using `get`, and use `suspend` method. To suspend its own task, use `Task.suspend`.

### resume

- Resume(Continue) the suspended task.

### terminate

- Terminate a task.

The following examples shows that the Task1 is controlled by the another task.

```Ruby
Task.name = "Task1"

puts "task1 started"

while true do
  puts "task1"
  sleep 1
end
```

```Ruby
task1 = Task.get("Task1")

sleep 3

puts "task1.suspend"
task1.suspend

sleep 3

puts "task1.resume"
task1.resume

sleep 3

puts "task1.terminate"
task1.terminate
```

### raise
### raise(Exception = RuntimeError)

- Throw an exeption into other task. If `Exception` is not given, `RuntimeError` is thrown.

### pass

- Pass the execution slot to another task. Release its own running status.

### value -> Object

- Return task termination value.

```Ruby
Task.name = "Task1"

sleep 3

["return value", 123, 456]
```

```Ruby
task1 = Task.get("Task1")

puts "waiting for Task1"
task1.join

p task1.value    # => ["return value", 123, 456]
```
